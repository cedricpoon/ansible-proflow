---
{% include "files/disclaimer.txt" %} 

# ansible-proflow v{{ version }} | MIT License
# Built from https://galaxy.ansible.com/cedricpoon/proflow

# For positive provision please update main.present.yml
# For negative provision please update main.absent.yml

- name: proflow | checkout state
  set_fact:
    __state__: "{{'{{'}} state | default('present') {{'}}'}}"
  when: __state__ is not defined

- name: proflow | check present
  stat:
    path: "{{'{{'}} role_path {{'}}'}}/tasks/main.present.yml"
  register: __present__
  delegate_to: localhost

- name: proflow | check absent
  stat:
    path: "{{'{{'}} role_path {{'}}'}}/tasks/main.absent.yml"
  register: __absent__
  delegate_to: localhost

- block:
  - name: proflow | behave as present
    include_tasks: "main.present.yml"
    when: __state__ == 'present' and __present__.stat.exists
  rescue:
    - name: proflow | failure without rollback
      fail:
        msg: failed task in present
      when: rollback is undefined
    - name: proflow | set state to absent for rollback
      set_fact:
        __state__: absent
      when: rollback is defined
    - name: proflow | start to rollback
      include_tasks: "{{'{{'}} playbook_dir {{'}}'}}/{{'{{'}} rollback {{'}}'}}"
      when: rollback is defined
    - name: proflow | end of rollback
      meta: end_play

- name: proflow | behave as absent
  include_tasks: "main.absent.yml"
  when: __state__ == 'absent' and __absent__.stat.exists
